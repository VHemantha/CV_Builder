# ============================================
# CV Builder - Render.com Blueprint
# ============================================
# Infrastructure as Code for automated deployment
# Docs: https://render.com/docs/blueprint-spec

services:
  # ============================================
  # Web Service (Flask App)
  # ============================================
  - type: web
    name: cv-builder
    runtime: docker
    dockerfilePath: ./Dockerfile
    plan: free  # Change to 'starter' or 'standard' for production
    region: oregon  # Choose: oregon, frankfurt, singapore, ohio
    branch: main
    healthCheckPath: /health
    autoDeploy: true

    # Scaling configuration
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 80
      targetCPUPercent: 80

    # Environment variables
    envVars:
      # Flask settings
      - key: FLASK_ENV
        value: production

      - key: FLASK_APP
        value: app:create_app

      # Secret key (auto-generated by Render)
      - key: SECRET_KEY
        generateValue: true

      # Database connection (auto-populated from database below)
      - key: DATABASE_URL
        fromDatabase:
          name: cv-builder-db
          property: connectionString

      # Redis connection (auto-populated from Redis service)
      - key: REDIS_URL
        fromService:
          name: cv-builder-redis
          type: redis
          property: connectionString

      # Base URL (set after first deploy)
      - key: APP_BASE_URL
        sync: false  # Must set manually in Render dashboard

      # Google OAuth (set manually in Render dashboard - NEVER commit secrets!)
      - key: GOOGLE_CLIENT_ID
        sync: false

      - key: GOOGLE_CLIENT_SECRET
        sync: false

      # CRITICAL: Ensure HTTPS in production
      - key: OAUTHLIB_INSECURE_TRANSPORT
        value: "0"

      # Feature flags
      - key: MAX_CVS_PER_USER
        value: "10"

      - key: DOWNLOAD_RATE_LIMIT
        value: "5/hour"

      - key: AI_ASSIST_ENABLED
        value: "false"

      - key: AI_CALLS_PER_DAY
        value: "10"

      # IP hash salt (auto-generated)
      - key: IP_HASH_SALT
        generateValue: true

      # Optional: Sentry error tracking
      - key: SENTRY_DSN
        sync: false

      # Optional: OpenAI for AI writing assistant
      - key: OPENAI_API_KEY
        sync: false

# ============================================
# Databases
# ============================================
databases:
  # PostgreSQL database
  - name: cv-builder-db
    databaseName: cvbuilder
    user: cvbuilder
    plan: free  # Change to 'starter' for production (90-day data retention)
    region: oregon
    ipAllowList: []  # Empty = allow from all Render services

  # Redis cache & rate limiter
  - name: cv-builder-redis
    type: redis
    plan: free  # 25MB, suitable for rate limiting; upgrade for caching
    region: oregon
    maxmemoryPolicy: allkeys-lru  # Evict least recently used keys when full
    ipAllowList: []

# ============================================
# Deployment Notes
# ============================================
#
# After first deployment:
# 1. Set APP_BASE_URL in Render dashboard (e.g., https://cv-builder.onrender.com)
# 2. Configure Google OAuth:
#    - Go to https://console.cloud.google.com/apis/credentials
#    - Add authorized redirect URI: https://YOUR_APP_URL/auth/callback
#    - Copy Client ID and Secret to Render env vars
# 3. (Optional) Set SENTRY_DSN for error tracking
# 4. (Optional) Set OPENAI_API_KEY if enabling AI writing assistant
#
# Migration management:
# - Migrations run automatically on deploy via docker-compose command
# - To run manual migrations: `flask db upgrade` in Render shell
#
# Monitoring:
# - App logs: Render dashboard → Logs tab
# - Database metrics: Render dashboard → Database → Metrics
# - Redis metrics: Render dashboard → Redis → Metrics
#
# Scaling:
# - Free tier: 1 instance, sleeps after 15min inactivity
# - Starter: Always-on, auto-scaling 1-3 instances
# - Production: Use 'standard' plan with dedicated resources
#
