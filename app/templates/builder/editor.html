{% extends "base.html" %}

{% block title %}Edit {{ cv.title }} | Free Resume Builder & CV Maker Online{% endblock %}

{% block description %}Edit and customize your professional resume with our free CV builder. Real-time preview, ATS-friendly templates, instant PDF download. Build your perfect resume now!{% endblock %}

{% block extra_css %}
<style>
    /* Modern Professional Design System */
    :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-900: #111827;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        --radius: 8px;
        --radius-lg: 12px;
    }

    body { margin: 0; padding: 0; background: var(--gray-50); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .container { max-width: 100%; padding: 0; margin: 0; }

    /* Header */
    .editor-header {
        background: white;
        padding: 16px 32px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-sm);
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .back-link {
        color: var(--gray-600);
        text-decoration: none;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.2s;
        font-weight: 500;
    }

    .back-link:hover {
        color: var(--primary);
    }

    .cv-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--gray-900);
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    /* Buttons */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        box-shadow: var(--shadow-sm);
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        box-shadow: var(--shadow);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: white;
        color: var(--gray-700);
        border: 1px solid var(--gray-300);
    }

    .btn-secondary:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
    }

    /* Save Indicator */
    .save-indicator {
        padding: 8px 16px;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .save-indicator.saved {
        background: #ecfdf5;
        color: var(--success);
    }

    .save-indicator.unsaved {
        background: #fef3c7;
        color: var(--warning);
    }

    .save-indicator.saving {
        background: var(--gray-100);
        color: var(--gray-600);
    }

    /* Layout */
    .editor-layout {
        display: grid;
        grid-template-columns: 480px 1fr;
        gap: 0;
        height: calc(100vh - 65px);
    }

    /* Form Panel */
    .form-panel {
        background: white;
        padding: 32px;
        overflow-y: auto;
        border-right: 1px solid var(--gray-200);
    }

    .form-panel::-webkit-scrollbar {
        width: 8px;
    }

    .form-panel::-webkit-scrollbar-track {
        background: var(--gray-100);
    }

    .form-panel::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 4px;
    }

    .form-panel::-webkit-scrollbar-thumb:hover {
        background: var(--gray-400);
    }

    /* Form Sections */
    .form-section {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 24px;
        transition: all 0.2s;
    }

    .form-section:hover {
        box-shadow: var(--shadow);
    }

    .form-section h2 {
        margin: 0 0 20px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--gray-900);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Form Groups */
    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: var(--gray-700);
        font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        font-family: inherit;
        font-size: 14px;
        transition: all 0.2s;
        background: white;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }

    .form-group small {
        display: block;
        margin-top: 4px;
        font-size: 12px;
        color: var(--gray-600);
    }

    /* Multi-entry */
    .multi-entry {
        border: 1px solid var(--gray-200);
        padding: 20px;
        margin-bottom: 16px;
        border-radius: var(--radius);
        background: white;
        transition: all 0.2s;
    }

    .multi-entry:hover {
        border-color: var(--gray-300);
        box-shadow: var(--shadow-sm);
    }

    /* Preview Panel */
    .preview-panel {
        background: #525659;
        padding: 32px;
        overflow-y: auto;
        display: flex;
        align-items: flex-start;
        justify-content: center;
    }

    .preview-iframe {
        width: 100%;
        max-width: 800px;
        min-height: 1000px;
        background: white;
        border: none;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
    }

    /* Grid layouts */
    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    /* Action buttons */
    .btn-danger {
        background: white;
        color: var(--danger);
        border: 1px solid var(--gray-300);
        font-size: 13px;
        padding: 8px 16px;
    }

    .btn-danger:hover {
        background: var(--danger);
        color: white;
        border-color: var(--danger);
    }

    .btn-add {
        background: white;
        color: var(--primary);
        border: 1px dashed var(--gray-300);
        margin-top: 8px;
    }

    .btn-add:hover {
        border-color: var(--primary);
        background: #eff6ff;
    }

    /* Save button */
    .save-all {
        width: 100%;
        padding: 14px;
        font-size: 15px;
        font-weight: 600;
        margin-top: 16px;
        background: var(--primary);
        color: white;
    }

    .save-all:hover {
        background: var(--primary-dark);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .editor-layout {
            grid-template-columns: 1fr;
        }

        .form-panel {
            border-right: none;
            border-bottom: 1px solid var(--gray-200);
        }

        .preview-panel {
            display: none;
        }
    }

    /* Status dot */
    .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-dot.green {
        background: var(--success);
    }

    .status-dot.yellow {
        background: var(--warning);
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-header">
    <div class="header-left">
        <a href="/cv/dashboard" class="back-link">
            ‚Üê Dashboard
        </a>
        <h1 class="cv-title">{{ cv.title }}</h1>
    </div>
    <div class="header-actions">
        <div class="save-indicator saved" id="saveStatus">
            <span class="status-dot green"></span>
            All changes saved
        </div>
        <button onclick="printPreview()" class="btn btn-primary">
            üñ®Ô∏è Print to PDF
        </button>
    </div>
</div>

<div class="editor-layout">
    <!-- Form Panel -->
    <div class="form-panel">
        <form id="cvForm" onsubmit="return false;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Personal Information -->
            <div class="form-section">
                <h2>üë§ Personal Information</h2>
                {% set personal = cv.sections.filter_by(section_type='personal').first() %}
                {% if personal %}
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="personal.name" value="{{ personal.content.name or '' }}" placeholder="John Doe" required>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="personal.email" value="{{ personal.content.email or '' }}" placeholder="john@example.com" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" name="personal.phone" value="{{ personal.content.phone or '' }}" placeholder="+1 (555) 123-4567">
                    </div>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" name="personal.location" value="{{ personal.content.location or '' }}" placeholder="San Francisco, CA">
                </div>
                <div class="form-group">
                    <label>Professional Headline</label>
                    <input type="text" name="personal.headline" value="{{ personal.content.headline or '' }}" placeholder="Senior Software Engineer">
                    <small>A brief title that summarizes your role</small>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>LinkedIn</label>
                        <input type="url" name="personal.linkedin" value="{{ personal.content.linkedin or '' }}" placeholder="linkedin.com/in/johndoe">
                    </div>
                    <div class="form-group">
                        <label>GitHub</label>
                        <input type="url" name="personal.github" value="{{ personal.content.github or '' }}" placeholder="github.com/johndoe">
                    </div>
                </div>
                <div class="form-group">
                    <label>Portfolio</label>
                    <input type="url" name="personal.portfolio" value="{{ personal.content.portfolio or '' }}" placeholder="johndoe.com">
                </div>
                {% endif %}
            </div>

            <!-- Summary -->
            <div class="form-section">
                <h2>üìù Professional Summary</h2>
                <div class="form-group">
                    <textarea name="summary" placeholder="Write 2-3 sentences highlighting your expertise, key skills, and career objectives...">{% set summary = cv.sections.filter_by(section_type='summary').first() %}{% if summary %}{{ summary.content.text or '' }}{% endif %}</textarea>
                    <small>This is your elevator pitch - make it count!</small>
                </div>
                <button type="button" onclick="addOrUpdateSection('summary')" class="btn btn-secondary">
                    {% if cv.sections.filter_by(section_type='summary').first() %}Update{% else %}Add{% endif %} Summary
                </button>
            </div>

            <!-- Experience -->
            <div class="form-section">
                <h2>üíº Work Experience</h2>
                <div id="experienceEntries">
                    {% for exp in cv.sections.filter_by(section_type='experience').all() %}
                    <div class="multi-entry">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Job Title *</label>
                                <input type="text" data-section-id="{{ exp.id }}" name="exp_title" value="{{ exp.content.title or '' }}" required>
                            </div>
                            <div class="form-group">
                                <label>Company *</label>
                                <input type="text" data-section-id="{{ exp.id }}" name="exp_company" value="{{ exp.content.company or '' }}" required>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="text" data-section-id="{{ exp.id }}" name="exp_start" value="{{ exp.content.start_date or '' }}" placeholder="Jan 2020">
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="text" data-section-id="{{ exp.id }}" name="exp_end" value="{{ exp.content.end_date or 'Present' }}" placeholder="Present">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" data-section-id="{{ exp.id }}" name="exp_location" value="{{ exp.content.location or '' }}" placeholder="Remote">
                        </div>
                        <div class="form-group">
                            <label>Key Achievements</label>
                            <textarea data-section-id="{{ exp.id }}" name="exp_description" placeholder="‚Ä¢ Led team of 5 developers...&#10;‚Ä¢ Increased performance by 40%...&#10;‚Ä¢ Shipped 15+ features...">{{ exp.content.description or '' }}</textarea>
                            <small>One achievement per line, start with a bullet point or action verb</small>
                        </div>
                        <button type="button" onclick="deleteSection('{{ exp.id }}')" class="btn btn-danger">Remove</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" onclick="addExperience()" class="btn btn-add btn-secondary">+ Add Experience</button>
            </div>

            <!-- Education -->
            <div class="form-section">
                <h2>üéì Education</h2>
                <div id="educationEntries">
                    {% for edu in cv.sections.filter_by(section_type='education').all() %}
                    <div class="multi-entry">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Degree *</label>
                                <input type="text" data-section-id="{{ edu.id }}" name="edu_degree" value="{{ edu.content.degree or '' }}" placeholder="Bachelor of Science" required>
                            </div>
                            <div class="form-group">
                                <label>Field of Study</label>
                                <input type="text" data-section-id="{{ edu.id }}" name="edu_field" value="{{ edu.content.field or '' }}" placeholder="Computer Science">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Institution *</label>
                            <input type="text" data-section-id="{{ edu.id }}" name="edu_institution" value="{{ edu.content.institution or '' }}" placeholder="University of California" required>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Graduation Year</label>
                                <input type="text" data-section-id="{{ edu.id }}" name="edu_year" value="{{ edu.content.year or '' }}" placeholder="2020">
                            </div>
                            <div class="form-group">
                                <label>GPA (optional)</label>
                                <input type="text" data-section-id="{{ edu.id }}" name="edu_gpa" value="{{ edu.content.gpa or '' }}" placeholder="3.8/4.0">
                            </div>
                        </div>
                        <button type="button" onclick="deleteSection('{{ edu.id }}')" class="btn btn-danger">Remove</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" onclick="addEducation()" class="btn btn-add btn-secondary">+ Add Education</button>
            </div>

            <!-- Skills -->
            <div class="form-section">
                <h2>‚ö° Skills</h2>
                {% set skills = cv.sections.filter_by(section_type='skills').first() %}
                <div class="form-group">
                    <label>Technical Skills</label>
                    <input type="text" name="skills.technical" value="{% if skills %}{{ skills.content.technical or '' }}{% endif %}"
                           placeholder="Python, JavaScript, React, Docker, AWS (comma-separated)">
                    <small>List your technical proficiencies</small>
                </div>
                <div class="form-group">
                    <label>Soft Skills</label>
                    <input type="text" name="skills.soft" value="{% if skills %}{{ skills.content.soft or '' }}{% endif %}"
                           placeholder="Leadership, Communication, Problem Solving">
                    <small>Interpersonal and professional skills</small>
                </div>
                <div class="form-group">
                    <label>Languages</label>
                    <input type="text" name="skills.languages" value="{% if skills %}{{ skills.content.languages or '' }}{% endif %}"
                           placeholder="English (Native), Spanish (Fluent)">
                </div>
                <button type="button" onclick="addOrUpdateSection('skills')" class="btn btn-secondary">
                    {% if skills %}Update{% else %}Add{% endif %} Skills
                </button>
            </div>

            <button type="button" onclick="saveCV()" class="btn save-all">
                üíæ Save All Changes
            </button>
        </form>
    </div>

    <!-- Preview Panel -->
    <div class="preview-panel">
        <iframe id="previewFrame" class="preview-iframe" src="/cv/{{ cv.id }}/preview"></iframe>
    </div>
</div>

<!-- Login Modal -->
<div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
        <h2 style="margin: 0 0 16px 0; color: #1a202c; font-size: 24px;">Sign in to Print</h2>
        <p style="color: #4a5568; margin: 0 0 30px 0; line-height: 1.6;">
            Please sign in with Google to print your CV to PDF. This helps us save your work and provide you with the best experience.
        </p>
        <div style="display: flex; gap: 12px; justify-content: center; flex-direction: column;">
            <a href="/auth/google" style="display: inline-flex; align-items: center; justify-content: center; gap: 12px; background: #4285f4; color: white; padding: 14px 28px; border-radius: 6px; text-decoration: none; font-weight: 500; font-size: 16px; transition: all 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </a>
            <button onclick="hideLoginModal()" style="background: #f1f3f4; color: #202124; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
const CV_ID = '{{ cv.id }}';
const CSRF_TOKEN = '{{ csrf_token() }}';
const IS_AUTHENTICATED = {{ 'true' if current_user.is_authenticated else 'false' }};

// Print preview function with authentication check
function printPreview() {
    // Check if user is authenticated
    if (!IS_AUTHENTICATED) {
        showLoginModal();
        return;
    }

    const printWindow = window.open(`/cv/${CV_ID}/preview`, '_blank', 'width=900,height=1100');

    if (printWindow) {
        printWindow.onload = function() {
            setTimeout(() => {
                printWindow.print();
            }, 500);
        };
    } else {
        alert('Please allow popups to print your CV');
    }
}

// Show login modal
function showLoginModal() {
    const modal = document.getElementById('loginModal');
    if (modal) {
        modal.style.display = 'flex';
    }
}

// Hide login modal
function hideLoginModal() {
    const modal = document.getElementById('loginModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Close modal on outside click
document.getElementById('loginModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideLoginModal();
    }
});
</script>
<script src="/static/js/cv_builder.js"></script>
{% endblock %}
