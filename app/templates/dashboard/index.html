{% extends "base.html" %}

{% block title %}{% if current_user.is_authenticated %}My CVs - Dashboard{% else %}Free CV Builder Dashboard{% endif %} | Professional Resume Maker{% endblock %}

{% block description %}Manage your professional resumes and CVs. Create, edit, and download ATS-friendly resumes for free. Build unlimited CVs with our free resume builder tool.{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
    }
    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-weight: 500;
    }
    .btn-primary {
        background: #4285f4;
        color: white;
    }
    .btn-primary:hover {
        background: #3367d6;
    }
    .btn-secondary {
        background: #f1f3f4;
        color: #202124;
    }
    .btn-secondary:hover {
        background: #e8eaed;
    }
    .btn-danger {
        background: #ea4335;
        color: white;
    }
    .cv-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    .cv-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        transition: box-shadow 0.2s;
        background: white;
    }
    .cv-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .cv-preview {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 48px;
        font-weight: bold;
        position: relative;
        overflow: hidden;
    }
    .cv-preview.ats_clean {
        background: linear-gradient(135deg, #434343 0%, #000000 100%);
    }
    .cv-preview.ats_modern {
        background: linear-gradient(135deg, #4299e1 0%, #2563eb 100%);
    }
    .cv-preview.ats_executive {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    }
    .cv-preview::after {
        content: '';
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        bottom: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 4px;
    }
    .cv-content {
        padding: 20px;
    }
    .cv-card h3 {
        margin: 0 0 10px 0;
        color: #202124;
    }
    .cv-meta {
        font-size: 0.9em;
        color: #5f6368;
        margin-bottom: 15px;
    }
    .cv-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .cv-actions a, .cv-actions button {
        font-size: 0.9em;
        padding: 8px 16px;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #5f6368;
    }
    .empty-state svg {
        width: 100px;
        height: 100px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="user-info">
        {% if current_user.is_authenticated and current_user.photo_url %}
        <img src="{{ current_user.photo_url }}" alt="{{ current_user.display_name }}" class="user-avatar" onerror="this.style.display='none'">
        {% endif %}
        <div>
            <h1 style="margin: 0;">{% if current_user.is_authenticated %}My CVs{% else %}CV Builder{% endif %}</h1>
            {% if current_user.is_authenticated %}
            <p style="margin: 5px 0 0 0; color: #5f6368;">{{ current_user.email }}</p>
            {% else %}
            <p style="margin: 5px 0 0 0; color: #5f6368;">Create professional CVs in minutes</p>
            {% endif %}
        </div>
    </div>
    <div>
        {% if current_user.is_authenticated %}
        <a href="/auth/logout" class="btn btn-secondary">Logout</a>
        {% else %}
        <a href="/auth/google" class="btn btn-primary">Sign In with Google</a>
        {% endif %}
    </div>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    {% if current_user.is_authenticated %}
    <p style="color: #5f6368; margin: 0;">
        {{ cvs|length }} of {{ max_cvs }} CVs created
    </p>
    {% if cvs|length < max_cvs %}
    <button onclick="showNewCVModal()" class="btn btn-primary">+ New CV</button>
    {% else %}
    <p style="color: #ea4335; margin: 0;">CV limit reached</p>
    {% endif %}
    {% else %}
    <p style="color: #5f6368; margin: 0;">
        Sign in to create and manage your CVs
    </p>
    <button onclick="window.location.href='/auth/google'" class="btn btn-primary">Get Started</button>
    {% endif %}
</div>

{% if cvs %}
<div class="cv-grid">
    {% for cv in cvs %}
    <div class="cv-card">
        <div class="cv-preview {{ cv.template_slug }}">
            ðŸ“„
        </div>
        <div class="cv-content">
            <h3>{{ cv.title }}</h3>
            <div class="cv-meta">
                <div>Template: <strong>{{ cv.template_slug|replace('_', ' ')|title }}</strong></div>
                <div>Updated: {{ cv.updated_at.strftime('%b %d, %Y') }}</div>
            </div>
            <div class="cv-actions">
                <a href="/cv/{{ cv.id }}/edit" class="btn btn-primary">Edit</a>
                {% if current_user.is_authenticated %}
                <button onclick="deleteCV('{{ cv.id }}', '{{ cv.title }}')" class="btn btn-danger">Delete</button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
    </svg>
    <h2>No CVs yet</h2>
    <p>Create your first CV to get started!</p>
    <button onclick="showNewCVModal()" class="btn btn-primary" style="margin-top: 20px;">Create My First CV</button>
</div>
{% endif %}

<!-- New CV Modal -->
<div id="newCVModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">Create New CV</h2>
        <form method="POST" action="/cv/new">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div style="margin-bottom: 20px;">
                <label for="title" style="display: block; margin-bottom: 5px; font-weight: 500;">CV Title</label>
                <input type="text" id="title" name="title" required
                       placeholder="e.g., Software Engineer Resume"
                       style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label for="template_slug" style="display: block; margin-bottom: 5px; font-weight: 500;">Template</label>
                <select id="template_slug" name="template_slug"
                        style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <option value="ats_clean">ATS Clean (Recommended)</option>
                    <option value="ats_modern">ATS Modern</option>
                    <option value="ats_executive">ATS Executive</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="hideNewCVModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Create CV</button>
            </div>
        </form>
    </div>
</div>

<script>
function showNewCVModal() {
    document.getElementById('newCVModal').style.display = 'flex';
}

function hideNewCVModal() {
    document.getElementById('newCVModal').style.display = 'none';
}

function deleteCV(cvId, cvTitle) {
    if (confirm(`Are you sure you want to delete "${cvTitle}"? This action cannot be undone.`)) {
        fetch(`/cv/${cvId}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete CV: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Failed to delete CV: ' + error);
        });
    }
}

// Close modal on outside click
document.getElementById('newCVModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideNewCVModal();
    }
});
</script>
{% endblock %}
